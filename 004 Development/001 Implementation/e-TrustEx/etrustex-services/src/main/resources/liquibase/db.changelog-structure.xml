<databaseChangeLog
	    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
	    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <changeSet id="6" author="chiricr">
        <comment>drop PRO_BUD_ID in ETR_TB_PROFILE</comment>
	    <dropColumn columnName="PRO_BUD_ID"
	            tableName="ETR_TB_PROFILE"/>
    </changeSet>

    <changeSet id="13" author="chiricr">
        <comment>add LOG_CLASS in ETR_TB_LOG</comment>
	    <addColumn tableName="ETR_TB_LOG">
	        <column name="LOG_CLASS" type="varchar(255)"/>
	    </addColumn>
    </changeSet>

	<changeSet id="27" author="guerrpa">
		<comment>ETRUSTEX-1098. Resize the field CERT_ENCODED_DATA in the table ETR_TB_CERTIFICATE</comment>
		<sql dbms="oracle"
			 splitStatements="true">
			ALTER TABLE ETR_TB_CERTIFICATE ADD (TMP_CERT_ENCODED_DATA  CLOB);
			UPDATE ETR_TB_CERTIFICATE SET TMP_CERT_ENCODED_DATA = CERT_ENCODED_DATA;
			ALTER TABLE ETR_TB_CERTIFICATE DROP COLUMN CERT_ENCODED_DATA;
			ALTER TABLE ETR_TB_CERTIFICATE RENAME COLUMN TMP_CERT_ENCODED_DATA TO CERT_ENCODED_DATA;
		</sql>
	</changeSet>

	<changeSet id="29" author="guerrpa">
		<comment>add username/date in ETR_TB_METADATA</comment>
		<addColumn tableName="ETR_TB_METADATA">
			<column name="CRE_DT" type="timestamp"/>
		</addColumn>
		<addColumn tableName="ETR_TB_METADATA">
			<column name="CRE_ID" type="varchar(255)"/>
		</addColumn>
		<addColumn tableName="ETR_TB_METADATA">
			<column name="MOD_DT" type="timestamp"/>
		</addColumn>
		<addColumn tableName="ETR_TB_METADATA">
			<column name="MOD_ID" type="varchar(255)"/>
		</addColumn>
	</changeSet>
	
    <changeSet id="36" author="chiricr">
        <comment>add ETR_TB_MESSAGE_PRIORITY</comment>
	    <createTable tableName="ETR_TB_MESSAGE_PRIORITY">
	    	<column name="MP_ID" type="number(19, 0)"/>
	    	<column name="MP_CRED_ID" type="number(19, 0)"/>
	    	<column name="MP_TRANS_ID" type="number(19, 0)"/>
	    	<column name="MP_PRIORITY" type="number(1, 0)"/>
	    	<column name="CRE_ID" type="varchar(255)"/>
	    	<column name="CRE_DT" type="timestamp"/>
	    	<column name="MOD_ID" type="varchar(255)"/>
	    	<column name="MOD_DT" type="timestamp"/>
	    </createTable>
	    <addUniqueConstraint columnNames="MP_CRED_ID, MP_TRANS_ID" tableName="ETR_TB_MESSAGE_PRIORITY"/>
    </changeSet>
    
    <changeSet id="37" author="chiricr">
        <comment>add ETR_TB_MONITORING_QUERY + PK ETR_TB_MESSAGE_PRIORITY</comment>
	    <createTable tableName="ETR_TB_MONITORING_QUERY">
	    	<column name="MON_ID" type="number(19, 0)"/>
	    	<column name="MON_QUERY" type="varchar(2000)"/>
	    </createTable>
	    <addPrimaryKey columnNames="MON_ID" tableName="ETR_TB_MONITORING_QUERY"/>
	    <addPrimaryKey columnNames="MP_ID" tableName="ETR_TB_MESSAGE_PRIORITY"/>
    </changeSet>

	<changeSet id="44" author="guerrpa">
		<comment>ETRUSTEX-1336 Implement event notification</comment>
		<renameTable newTableName="CPA_TB_EVT_NOTIF"
					 oldTableName="CPA_TB_CFG_NOTIF"/>

		<renameColumn columnDataType="NUMBER(19,0)"
					  newColumnName="EVT_ID"
					  oldColumnName="CNN_ID"
					  tableName="CPA_TB_EVT_NOTIF"/>

		<renameColumn columnDataType="NUMBER(19,0)"
					  newColumnName="EVT_PRO_ID"
					  oldColumnName="CNN_PRO_ID"
					  tableName="CPA_TB_EVT_NOTIF"/>

		<renameColumn columnDataType="NUMBER(19,0)"
					  newColumnName="EVT_CBD_ID"
					  oldColumnName="CNN_CBD_ID"
					  tableName="CPA_TB_EVT_NOTIF"/>

		<renameColumn columnDataType="NUMBER(19,0)"
					  newColumnName="EVT_PTY_ID"
					  oldColumnName="CNN_PTY_ID"
					  tableName="CPA_TB_EVT_NOTIF"/>
	</changeSet>

	<changeSet id="45" author="guerrpa">
		<addColumn tableName="CPA_TB_EVT_NOTIF">
			<column name="EVT_TYPE" type="varchar(255)"/>
		</addColumn>
	</changeSet>

	<changeSet id="46" author="guerrpa">
		<preConditions onFail="CONTINUE">
			<indexExists indexName="CNN_UK_ID"/>
		</preConditions>
		<dropUniqueConstraint tableName="CPA_TB_EVT_NOTIF"
							  constraintName="CNN_UK_ID"/>
	</changeSet>

	<changeSet id="47" author="guerrpa">
		<preConditions>
			<not>
				<indexExists indexName="CNN_UK_ID"/>
			</not>
		</preConditions>
		<addUniqueConstraint columnNames="EVT_PRO_ID, EVT_CBD_ID, EVT_PTY_ID, EVT_TYPE"
							 constraintName="ENN_UK_ID"
							 tableName="CPA_TB_EVT_NOTIF"/>
	</changeSet>
	
    <changeSet id="48" author="chiricr">
        <comment>add ETR_TB_ENDPOINT_AMQP</comment>
	    <createTable tableName="ETR_TB_ENDPOINT_AMQP">
	    	<column name="ID" type="number(19, 0)"/>
	    	<column name="EDP_AMQP_PROV_URL" type="varchar(255)"/>
	    </createTable>
	    <addPrimaryKey columnNames="ID" tableName="ETR_TB_ENDPOINT_AMQP"/>
	    <addForeignKeyConstraint constraintName="FK_EDPAMQP_EDP" referencedTableName="ETR_TB_ENDPOINT" referencedColumnNames="EDP_ID" 
	    	baseTableName="ETR_TB_ENDPOINT_AMQP" baseColumnNames="ID" />
    </changeSet>

	<changeSet id="57" author="guerrpa">
		<comment>add new column to allow uniqueness per proxy host + port, provider url, etc</comment>
		<addColumn tableName="ETR_TB_CREDENTIALS">
			<column name="CRED_TYPE" type="varchar(255)"/>
		</addColumn>
	</changeSet>
	
	<changeSet id="-10" author="chiricr">
		<comment>Add index on CRED_USER column in ETR_TB_CREDENTIALS</comment>
		<createIndex tableName="ETR_TB_CREDENTIALS" indexName="IDX_CRED_USER">
			<column name="CRED_USER"/>
		</createIndex>
	</changeSet>	
</databaseChangeLog>