<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:util="http://www.springframework.org/schema/util" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:tx="http://www.springframework.org/schema/tx" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:int-jmx="http://www.springframework.org/schema/integration/jmx"
	xmlns:jee="http://www.springframework.org/schema/jee"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:task="http://www.springframework.org/schema/task"
	xsi:schemaLocation="http://www.springframework.org/schema/beans 
       http://www.springframework.org/schema/beans/spring-beans-3.0.xsd 
       http://www.springframework.org/schema/integration/jmx 
	   http://www.springframework.org/schema/integration/jmx/spring-integration-jmx.xsd
       http://www.springframework.org/schema/util 
       http://www.springframework.org/schema/util/spring-util-3.0.xsd
       http://www.springframework.org/schema/tx 
       http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/aop
       http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
       http://www.springframework.org/schema/task 
       http://www.springframework.org/schema/task/spring-task-3.1.xsd
       http://www.springframework.org/schema/jee
       http://www.springframework.org/schema/jee/spring-jee-3.0.xsd"
	default-autowire="byName">



	<import resource="classpath*:endpoints/*.xml" />
	<import resource="classpath*:business/*.xml" />
	<import resource="classpath*:processing/*.xml" />
	<import resource="classpath*:module/*.xml" />
	<import resource="classpath*:routing/*.xml" />
	<import resource="classpath:etrustex-services-context.xml" />
	
	
	<!-- PROFILING -->
<!-- 	<bean name="loggingInterceptor" class="eu.europa.ec.cipa.etrustex.integration.util.EtrustexProfiler"/>    -->
<!-- 	<aop:config> -->
<!--     	<aop:pointcut id="activator" expression="execution(* eu.europa.ec.cipa.etrustex.integration.service.*Activator.*(..))"/> -->
<!--     	<aop:pointcut id="gateway" expression="execution(* eu.europa.ec.cipa.etrustex.integration.gateway.*.*(..))"/> -->
<!--     	<aop:pointcut id="business" expression="execution(* eu.europa.ec.cipa.etrustex.integration.business.*.*(..))"/> -->
<!--     	<aop:pointcut id="transformers" expression="execution(* eu.europa.ec.cipa.etrustex.integration.transformers.SAAJSOAPToTrustExMessageTransformer.*(..))"/> -->
<!--     	<aop:pointcut id="sec" expression="execution(* eu.europa.ec.cipa.etrustex.integration.security.xwss.XwsSecurityInterceptor.*(..))"/> -->
<!--     	<aop:pointcut id="dispMsg" expression="execution(* eu.europa.ec.cipa.etrustex.integration.dispatcher.WSMessageDispatcher.*(..))"/> -->
    	
<!--     	<aop:advisor advice-ref="loggingInterceptor" pointcut-ref="activator"/> -->
<!--     	<aop:advisor advice-ref="loggingInterceptor" pointcut-ref="gateway"/> -->
<!--     	<aop:advisor advice-ref="loggingInterceptor" pointcut-ref="business"/> -->
<!--     	<aop:advisor advice-ref="loggingInterceptor" pointcut-ref="transformers"/> -->
<!--     	<aop:advisor advice-ref="loggingInterceptor" pointcut-ref="sec"/> -->
<!--     	<aop:advisor advice-ref="loggingInterceptor" pointcut-ref="dispMsg"/> -->
<!-- 	</aop:config> -->
	
<!-- 	<context:mbean-server  />

	<int-jmx:mbean-export id="etrustExMBeanExporter" default-domain="spring.application" />

	<context:mbean-export default-domain="spring.application" />
	
 -->
	<context:annotation-config />
	<context:component-scan base-package="eu.europa.ec.cipa.etrustex.integration"/>
    <task:annotation-driven/>
    <aop:aspectj-autoproxy/>
	
<!-- 	<bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl"> -->
<!-- 		<property name="host" value="smtp.gmail.com" /> -->
<!-- 		<property name="port" value="587" /> -->
<!-- 		<property name="username" value="etrustex@gmail.com" /> -->
<!-- 		<property name="password" value="Cipa2013" /> -->
	 
<!-- 		<property name="javaMailProperties"> -->
<!-- 		   <props> -->
<!-- 	       	      <prop key="mail.smtp.auth">true</prop> -->
<!-- 	       	      <prop key="mail.smtp.starttls.enable">true</prop> -->
<!-- 	       	   </props> -->
<!-- 		</property> -->
<!-- 	</bean> -->
<!-- 	<bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl"> -->
<!-- 		<property name="host" value="outlook.net1.cec.eu.int" /> -->
<!-- 		<property name="port" value="25" /> -->
<!-- 		<property name="username" value="Sandro.D'ORAZIO@ec.europa.eu" /> -->
<!-- 		<property name="password" value="berardo27K" /> -->
	 
<!-- 		<property name="javaMailProperties"> -->
<!-- 		   <props> -->
<!-- 	       	      <prop key="mail.smtp.auth">true</prop> -->
<!-- 	       	      <prop key="mail.smtp.starttls.enable">true</prop> -->
<!-- 	       	   </props> -->
<!-- 		</property> -->
<!-- 	</bean> -->

	
	
	<bean id="freemarkerConfig"
		class="org.springframework.ui.freemarker.FreeMarkerConfigurationFactoryBean">
		<description>Using the Config directly so we can use it outside the	web tier</description>
		<property name="templateLoaderPaths" value="classpath:/templates"/>
		<property name="freemarkerSettings">
			<props>
				<prop key="datetime_format">dd/MM/yyyy</prop>
				<prop key="number_format">#</prop>
				<prop key="whitespace_stripping">true</prop>
			</props>
		</property>
		<!-- property name="freemarkerVariables"> <map> <entry key="xml_escape" 
			value-ref="fmXmlEscape" /> <entry key="html_escape" value-ref="fmHtmlEscape" 
			/> </map> </property> -->
	</bean>
	
	
	<bean id="jmsConnectionFactory" class="org.springframework.jndi.JndiObjectFactoryBean">
		<property name="jndiName" value="${jmsConnectionFactory.name}"/>
	</bean>

	<bean id="toAsynchProcessingQueue" class="org.springframework.jndi.JndiObjectFactoryBean">
		<property name="jndiName" value="${integrationqueue.name}" />
	</bean>
	
	<bean id="waitingRoomQueue" class="org.springframework.jndi.JndiObjectFactoryBean">
		<property name="jndiName" value="${waitingroomqueue.name}" />
	</bean>
	<bean id="errorQueue" class="org.springframework.jndi.JndiObjectFactoryBean">
		<property name="jndiName" value="${errorqueue.name}" />
	</bean>
	
	<bean id="routingQueue" class="org.springframework.jndi.JndiObjectFactoryBean">
		<property name="jndiName" value="${routingqueue.name}" />
	</bean>
	
	<bean id="documentQueue" class="org.springframework.jndi.JndiObjectFactoryBean">
		<property name="jndiName" value="${documentqueue.name}" />
	</bean>
	
	
	
<!-- 	<bean id="etrustexAmqpQueue" class="org.springframework.jndi.JndiObjectFactoryBean"> -->
<!-- 		<property name="jndiName" value="amqp/etrustexAmqpQueue" /> -->
<!-- 	</bean>		 -->
	
	
	<bean id="trustexMessageConverter" class="eu.europa.ec.cipa.etrustex.integration.util.TrustExMessageConverter"/>
	
	<bean id="toAsynchProcessingTemplate" class="org.springframework.jms.core.JmsTemplate" >
		<property name="connectionFactory">
			<ref bean="jmsConnectionFactory" />
		</property>
		<property name="defaultDestination">
			<ref bean="toAsynchProcessingQueue" />
		</property>
		<property name="receiveTimeout">
			<value>30000</value>
		</property>
		<property name="messageConverter">
			<ref bean="trustexMessageConverter" />
		</property>		
	</bean>
	
	<bean id="toErrorQueueTemplate" class="org.springframework.jms.core.JmsTemplate">
		<property name="connectionFactory">
			<ref bean="jmsConnectionFactory" />
		</property>
		<property name="defaultDestination">
			<ref bean="errorQueue" />
		</property>
		<property name="receiveTimeout">
			<value>30000</value>
		</property>
		<property name="messageConverter">
			<ref bean="trustexMessageConverter" />
		</property>		
	</bean>
	
	<bean id="toWaitingRoomTemplate" class="org.springframework.jms.core.JmsTemplate">
		<property name="connectionFactory">
			<ref bean="jmsConnectionFactory" />
		</property>
		<property name="defaultDestination">
			<ref bean="waitingRoomQueue" />
		</property>
		<property name="receiveTimeout">
			<value>30000</value>
		</property>
		<property name="messageConverter">
			<ref bean="trustexMessageConverter" />
		</property>		
	</bean>
	
	<bean id="toRoutingQueueTemplate" class="org.springframework.jms.core.JmsTemplate">
		<property name="connectionFactory">
			<ref bean="jmsConnectionFactory" />
		</property>
		<property name="defaultDestination">
			<ref bean="routingQueue" />
		</property>
		<property name="receiveTimeout">
			<value>30000</value>
		</property>
		<property name="messageConverter">
			<ref bean="trustexMessageConverter" />
		</property>		
	</bean>
	
	<!-- JMS MessageListenerContainer for the new JMS interface -->
   	<bean class="org.springframework.jms.listener.DefaultMessageListenerContainer">
        <property name="connectionFactory" ref="jmsConnectionFactory"/>
        <property name="destination" ref="documentQueue"/> 
        <property name="transactionManager" ref="transactionManager"/>
        <property name="messageListener">
            <bean class="eu.europa.ec.cipa.etrustex.integration.ejb.DocumentQueueMessageListener">
                <property name="messageFactory" ref="messageFactory"/>
                <property name="messageReceiver" ref="jmsMessageReceiver"/>
            </bean>
        </property>
    </bean>   	
    	 
	<bean id="jmsMessageReceiver" class="org.springframework.ws.soap.server.SoapMessageDispatcher">
        <property name="endpointMappings" ref="documentEndpointMapping"/>
        <!-- <property name="endpointExceptionResolvers">
			<list>
				<ref bean="resolver" />
			</list>
		</property> --> 
    </bean>
    
    <bean id="documentEndpointMapping" class="org.springframework.ws.server.endpoint.mapping.PayloadRootQNameEndpointMapping">        
        <property name="mappings">
			<props>
				<!-- jmsMessageEndpoint is the class eu.europa.ec.cipa.etrustex.integration.gateway.JmsMessageEndpoint -->
				<prop key="{ec:services:wsdl:Document-1}SubmitDocumentRequest">jmsMessageEndpoint</prop>
			</props>	        
	    </property>
	    <!-- defaultEndpoint is the class eu.europa.ec.cipa.etrustex.integration.gateway.ETrustEXDefaultEndpoint -->
		<property name="defaultEndpoint" ref="defaultEndpoint" /> 	
				
	</bean>
	
    <!-- SOAP over JMS outbound interface  -->    
    <bean id="replyJmsTemplate" class="org.springframework.jms.core.JmsTemplate">
		<property name="connectionFactory">
			<ref bean="jmsConnectionFactory" />
		</property>		
		<property name="receiveTimeout">
			<value>30000</value>
		</property>
		<property name="messageConverter">
			<ref bean="trustexMessageConverter" />
		</property>		
	</bean>
	
	<!-- template used for sending configuration notifications to the documentQueue -->
    <bean id="toDocumentQueueTemplate" class="org.springframework.jms.core.JmsTemplate">
		<property name="connectionFactory">
			<ref bean="jmsConnectionFactory" />
		</property>		
		<property name="defaultDestination">
			<ref bean="documentQueue" />
		</property>
		<property name="receiveTimeout">
			<value>30000</value>
		</property>
		<property name="messageConverter">
			<ref bean="eventNotificationMessageConverter" />
		</property>		
	</bean>
	
	
    <bean id="loggingInterceptor" class="eu.europa.ec.cipa.etrustex.integration.util.LoggingInterceptor"/>
    
    
    <!-- JavaMail setup -->
	<bean id="mailSession" class="org.springframework.jndi.JndiObjectFactoryBean">
		<property name="jndiName" value="${mailSession.name}"/>
	</bean>   
	
	<bean id="mailSender" class="eu.europa.ec.cipa.etrustex.integration.util.JndiSessionMailSender">
		<property name="session" ref="mailSession"/>
	</bean> 
	
	<!-- Monitoring -->
	<bean id="monitoringTask" class="eu.europa.ec.cipa.etrustex.integration.task.MonitoringTask">
		<property name="enableMonitoring" value="${etrustex.enableMonitoring}"/>
	</bean>
	
	<!-- ActiveMQ AMQP broker config -->
<!-- 	<bean id="activemqPropertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"> -->
<!-- 	    <property name="location"> -->
<!-- 	        <value>classpath:activemq-jndi.properties</value> -->
<!-- 	    </property> -->
<!-- 	</bean>	 -->
	
	
	
	
	
	
	
	
	
	
	
<!-- 	TODO:: AMQP Related -->
<!-- 	<bean id="activemqJndiTemplate" class="org.springframework.jndi.JndiTemplate">   -->
<!--         <property name="environment">   -->
<!--             <props>   -->
<!-- 	            <prop key="java.naming.factory.initial">org.apache.qpid.amqp_1_0.jms.jndi.PropertiesFileInitialContextFactory</prop> -->
<!-- 	            the file activemq-jndi.properties needs to be put in the root directory of the Weblogic domain -->
<!-- 	            <prop key="java.naming.provider.url">activemq-jndi.properties</prop> -->
<!--             </props>   -->
<!--         </property>   -->
<!--     </bean>  	     -->
	
<!-- 	<bean id="amqpQueue" class="org.springframework.jndi.JndiObjectFactoryBean"> -->
<!-- 		<property name="jndiTemplate" ref="activemqJndiTemplate"/> -->
<!-- 		<property name="jndiName" value="amqpQueue" /> -->
<!-- 	</bean>	     -->
    
<!-- 	<bean id="activemqConnectionFactory" class="org.springframework.jndi.JndiObjectFactoryBean"> -->
<!-- 		<property name="jndiTemplate" ref="activemqJndiTemplate"/> -->
<!-- 		<property name="jndiName" value="activemqConnectionFactory"/> -->
<!-- 	</bean>     -->
 
<!--   	<bean class="org.springframework.jms.listener.DefaultMessageListenerContainer"> -->
<!--         <property name="connectionFactory" ref="activemqConnectionFactory"/> -->
<!--         <property name="destination" ref="amqpQueue"/>  -->
<!--         <property name="transactionManager" ref="transactionManager"/> -->
<!--         <property name="messageListener"> -->
<!--             <bean class="eu.europa.ec.cipa.etrustex.integration.ejb.AmqpQueueMessageListener"> -->
<!--                 <property name="messageFactory" ref="messageFactory"/> -->
<!--                 <property name="messageReceiver" ref="jmsMessageReceiver"/> -->
<!--             </bean> -->
<!--         </property> -->
<!--     </bean> 	 -->
    
<!-- 	<bean id="testDispatchQueue" class="org.springframework.jndi.JndiObjectFactoryBean"> -->
<!-- 		<property name="jndiTemplate" ref="activemqJndiTemplate"/> -->
<!-- 		<property name="jndiName" value="testDispatchQueue" /> -->
<!-- 	</bean>	     -->
     
<!--   	<bean class="org.springframework.jms.listener.DefaultMessageListenerContainer"> -->
<!--         <property name="connectionFactory" ref="activemqConnectionFactory"/> -->
<!--         <property name="destination" ref="testDispatchQueue"/>  -->
<!--         <property name="transactionManager" ref="transactionManager"/> -->
<!--         <property name="messageListener"> -->
<!--             <bean class="eu.europa.ec.cipa.etrustex.integration.ejb.TestDispatchQueueMessageListener"> -->
<!--                 <property name="messageFactory" ref="messageFactory"/> -->
<!--                 <property name="messageReceiver" ref="jmsMessageReceiver"/> -->
<!--             </bean> -->
<!--         </property> -->
<!--     </bean>     -->
   
</beans>
